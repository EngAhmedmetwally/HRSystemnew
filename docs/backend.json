{
  "entities": {
    "Employee": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Employee",
      "type": "object",
      "description": "Represents an employee in the HR Pulse system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the employee."
        },
        "employeeId": {
          "type": "string",
          "description": "Employee ID, might be different from the unique 'id'."
        },
        "name": {
          "type": "string",
          "description": "Full name of the employee."
        },
        "password": {
          "type": "string",
          "description": "Password for the employee's account."
        },
        "department": {
          "type": "string",
          "description": "Department the employee belongs to."
        },
        "jobTitle": {
          "type": "string",
          "description": "Job title of the employee."
        },
        "contractType": {
          "type": "string",
          "description": "Type of contract the employee has (e.g., full-time, part-time)."
        },
        "hireDate": {
          "type": "string",
          "description": "Date when the employee was hired.",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "description": "Current status of the employee (e.g., active, inactive)."
        },
        "baseSalary": {
          "type": "number",
          "description": "Base salary of the employee."
        },
        "deviceVerificationEnabled": {
          "type": "boolean",
          "description": "Whether to enforce device ID verification for this employee."
        },
        "deviceId": {
            "type": "string",
            "description": "The unique device ID registered for this employee."
        }
      },
      "required": [
        "id",
        "employeeId",
        "name",
        "department",
        "jobTitle",
        "contractType",
        "hireDate",
        "status",
        "baseSalary"
      ]
    },
    "Allowance": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Allowance",
      "type": "object",
      "description": "Represents an allowance for an employee.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the allowance."
        },
        "employeeId": {
          "type": "string",
          "description": "Reference to Employee. (Relationship: Employee 1:N Allowance)"
        },
        "name": {
          "type": "string",
          "description": "Name of the allowance (e.g., housing allowance, transportation allowance)."
        },
        "amount": {
          "type": "number",
          "description": "Amount of the allowance."
        }
      },
      "required": [
        "id",
        "employeeId",
        "name",
        "amount"
      ]
    },
    "WorkDay": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "WorkDay",
      "type": "object",
      "description": "Represents a workday and attendance information for employees.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the workday."
        },
        "date": {
          "type": "string",
          "description": "Date of the workday.",
          "format": "date-time"
        },
        "employeeId": {
          "type": "string",
          "description": "Reference to Employee. (Relationship: Employee 1:N WorkDay)"
        },
        "checkInTime": {
          "type": "string",
          "description": "Time when the employee checked in.",
          "format": "date-time"
        },
        "checkOutTime": {
          "type": "string",
          "description": "Time when the employee checked out.",
          "format": "date-time",
          "nullable": true
        },
        "totalWorkHours": {
          "type": "number",
          "description": "Total work hours for the day."
        },
        "delayMinutes": {
          "type": "number",
          "description": "Number of delay minutes."
        },
        "overtimeHours": {
          "type": "number",
          "description": "Number of overtime hours."
        }
      },
      "required": [
        "id",
        "date",
        "employeeId",
        "checkInTime",
        "totalWorkHours",
        "delayMinutes",
        "overtimeHours"
      ]
    },
    "DeductionPolicy": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "DeductionPolicy",
      "type": "object",
      "description": "Represents a deduction policy for delays, absences, and early departures.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the deduction policy."
        },
        "gracePeriodMinutes": {
          "type": "number",
          "description": "Grace period in minutes before delay deductions apply."
        },
        "delayDeductionRate": {
          "type": "number",
          "description": "Deduction rate for delays (e.g., every 15 minutes of delay = 1 hour deduction)."
        },
        "earlyDepartureDeductionRate": {
          "type": "number",
          "description": "Deduction rate for early departures."
        },
        "absenceDeductionRate": {
          "type": "number",
          "description": "Deduction rate for absences."
        }
      },
      "required": [
        "id",
        "gracePeriodMinutes",
        "delayDeductionRate",
        "earlyDepartureDeductionRate",
        "absenceDeductionRate"
      ]
    },
    "Payroll": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Payroll",
      "type": "object",
      "description": "Represents a payroll record for an employee for a specific month.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the payroll record."
        },
        "employeeId": {
          "type": "string",
          "description": "Reference to Employee. (Relationship: Employee 1:N Payroll)"
        },
        "month": {
          "type": "number",
          "description": "Month for which the payroll is calculated."
        },
        "year": {
          "type": "number",
          "description": "Year for which the payroll is calculated."
        },
        "basicSalary": {
          "type": "number",
          "description": "Basic salary for the employee."
        },
        "allowances": {
          "type": "number",
          "description": "Total allowances for the employee."
        },
        "deductions": {
          "type": "number",
          "description": "Total deductions for the employee."
        },
        "overtimePay": {
          "type": "number",
          "description": "Overtime pay for the employee."
        },
        "netSalary": {
          "type": "number",
          "description": "Net salary for the employee (basic salary + allowances + overtime pay - deductions)."
        }
      },
      "required": [
        "id",
        "employeeId",
        "month",
        "year",
        "basicSalary",
        "allowances",
        "deductions",
        "overtimePay",
        "netSalary"
      ]
    },
    "QrCode": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "QrCode",
      "type": "object",
      "description": "Represents a QR code generated for attendance tracking.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the QR code."
        },
        "sessionId": {
          "type": "string",
          "description": "Session ID associated with the QR code."
        },
        "date": {
          "type": "string",
          "description": "Date when the QR code was generated.",
          "format": "date-time"
        },
        "type": {
          "type": "string",
          "description": "Type of attendance (e.g., check-in, check-out)."
        },
        "token": {
          "type": "string",
          "description": "Secret token associated with the QR code for security."
        },
        "validUntil": {
          "type": "string",
          "description": "Expiration date/time for the QR code.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "sessionId",
        "date",
        "type",
        "token",
        "validUntil"
      ]
    },
     "SystemSetting": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SystemSetting",
      "type": "object",
      "description": "Stores general system settings for the HR application.",
      "properties": {
        "checkInTime": { "type": "string", "format": "time", "description": "Default check-in time for all employees." },
        "checkOutTime": { "type": "string", "format": "time", "description": "Default check-out time for all employees." },
        "qrRefreshRate": { "type": "number", "description": "How often the attendance QR code refreshes, in seconds." },
        "gracePeriod": { "type": "number", "description": "Grace period in minutes before an employee is marked as late." },
        "locationLat": { "type": "string", "description": "Latitude of the primary work location." },
        "locationLng": { "type": "string", "description": "Longitude of the primary work location." },
        "allowedRadius": { "type": "number", "description": "Allowed radius in meters from the primary work location for clock-in." },
        "deductionLevels": {
          "type": "array",
          "description": "Array of deduction rules for tardiness.",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "minutes": { "type": "number" },
              "deductionType": { "type": "string", "enum": ["minutes", "hours", "amount"] },
              "deductionValue": { "type": "number" }
            },
            "required": ["id", "minutes", "deductionType", "deductionValue"]
          }
        }
      }
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/employees/{employeeId}",
        "definition": {
          "entityName": "Employee",
          "schema": {
            "$ref": "#/backend/entities/Employee"
          },
          "description": "Stores employee information. Uses path-based ownership for simplified security rules.",
          "params": [
            {
              "name": "employeeId",
              "description": "Unique identifier for the employee."
            }
          ]
        }
      },
      {
        "path": "/workDays/{workDayId}",
        "definition": {
          "entityName": "WorkDay",
          "schema": {
            "$ref": "#/backend/entities/WorkDay"
          },
          "description": "Stores daily attendance data for each employee.",
          "params": [
            {
              "name": "workDayId",
              "description": "Unique identifier for the work day."
            }
          ]
        }
      },
      {
        "path": "/deductionPolicies/{deductionPolicyId}",
        "definition": {
          "entityName": "DeductionPolicy",
          "schema": {
            "$ref": "#/backend/entities/DeductionPolicy"
          },
          "description": "Stores deduction policies. Access controlled via roles collections.",
          "params": [
            {
              "name": "deductionPolicyId",
              "description": "Unique identifier for the deduction policy."
            }
          ]
        }
      },
       {
        "path": "/settings/{settingId}",
        "definition": {
          "entityName": "SystemSetting",
          "schema": {
            "$ref": "#/backend/entities/SystemSetting"
          },
          "description": "Stores global system settings. Only accessible by admins.",
          "params": [
            {
              "name": "settingId",
              "description": "Unique identifier for the settings document (e.g., 'general')."
            }
          ]
        }
      },
      {
        "path": "/payrolls/{payrollId}",
        "definition": {
          "entityName": "Payroll",
          "schema": {
            "$ref": "#/backend/entities/Payroll"
          },
          "description": "Stores payroll records for each employee per month. Path-based ownership based on employee ID.",
          "params": [
            {
              "name": "payrollId",
              "description": "Unique identifier for the payroll record."
            }
          ]
        }
      },
      {
        "path": "/qrCodes/{qrCodeId}",
        "definition": {
          "entityName": "QrCode",
          "schema": {
            "$ref": "#/backend/entities/QrCode"
          },
          "description": "Stores QR code data for attendance tracking. Includes session ID, date, type, token, and validity period. Protects against fake attendance.",
          "params": [
            {
              "name": "qrCodeId",
              "description": "Unique identifier for the QR code."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{uid}",
        "definition": {
          "entityName": "role",
          "schema": {
            "$ref": "#/backend/entities/Employee"
          },
          "description": "Collection to store admin roles. Document existence determines admin privileges.",
          "params": [
            {
              "name": "uid",
              "description": "User ID of the admin."
            }
          ]
        }
      },
      {
        "path": "/roles_hr/{uid}",
        "definition": {
          "entityName": "role",
          "schema": {
            "$ref": "#/backend/entities/Employee"
          },
          "description": "Collection to store HR roles. Document existence determines HR privileges.",
          "params": [
            {
              "name": "uid",
              "description": "User ID of the HR personnel."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to automate HR operations with a focus on attendance tracking and payroll management. The design prioritizes authorization independence and follows the DBAC principle, storing roles implicitly based on collection membership. The structure uses path-based ownership for user-related data (employees) and denormalization where needed to avoid `get()` calls in security rules.\n\n*   **/employees/{employeeId}**: Stores employee information. Used path-based ownership which simplifies security rules related to employee-specific data. Employee IDs are used for secure access to their own records.\n*   **/workDays/{workDayId}**: Stores daily attendance data for each employee in a single collection. This simplifies querying for all attendance records or filtering by day.\n*   **/deductionPolicies/{deductionPolicyId}**: Stores deduction policies. The lack of inherent user relationships here suggests a global scope, meaning the DBAC (database-enforced access control) can be applied by granting access through collection existence checks (e.g., `/roles_admin/{uid}`).\n*   **/settings/{settingId}**: Stores global system settings, accessible only by admins.\n*   **/payrolls/{payrollId}**: Stores payroll records for each employee per month in a single collection, simplifying queries. Ownership is checked via a field in the document.\n*   **/qrCodes/{qrCodeId}**: Stores QR code data for attendance tracking. Data includes session ID, date, type, token, and validity period. The security model prevents fake attendance by linking the QR code to a specific session and employee, enforced by Firebase Security Rules. Each QR code is valid for a short duration.\n*   **/roles_admin/{uid}**: Collection used to store admin roles. Document existence determines admin privileges.\n*   **/roles_hr/{uid}**: Collection used to store HR roles. Document existence determines HR privileges.\n\nThis structure provides Authorization Independence by denormalizing authorization context. For example, access to an employee's `workDays` or `payrolls` is determined by the employee ID in the path, not by fetching data from the parent `employee` document. This eliminates the need for `get()` calls in security rules.\n\nThe structure also supports the required QAPs:\n\n*   **Secure List Operations:** Segregation of data into collections with homogeneous security postures enables secure `list` operations. For example, listing all employees is secure because all documents in the `/employees` collection have the same access control requirements.\n*   **Role-Based Access Control:** Roles are managed using dedicated collections (`roles_admin`, `roles_hr`). The security rules can check for the existence of a document in these collections to grant access to sensitive operations."
  }
}
